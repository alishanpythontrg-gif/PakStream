<!DOCTYPE html>
<html>
<head>
    <title>Final Verification Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: white; }
        .container { max-width: 600px; margin: 0 auto; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .success { background: #4CAF50; color: white; }
        .error { background: #f44336; color: white; }
        .info { background: #2196F3; color: white; }
        .progress { width: 100%; height: 20px; background: #333; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-bar { height: 100%; background: #4CAF50; width: 0%; transition: width 0.3s; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Final Verification Test</h1>
        <p>Testing all components to ensure everything is working properly.</p>
        
        <div id="status"></div>
        <div class="progress" id="progressContainer" style="display: none;">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <button onclick="testBackend()">🔧 Test Backend</button>
        <button onclick="testFrontend()">🎨 Test Frontend</button>
        <button onclick="testUpload()">📤 Test Upload</button>
        <button onclick="testProgress()">📊 Test Progress</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const API_BASE = 'http://localhost:5000/api';
        const socket = io('http://localhost:5000');
        let authToken = null;

        function log(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            const timestamp = new Date().toLocaleTimeString();
            statusDiv.innerHTML += `<div class="status ${type}">[${timestamp}] ${message}</div>`;
        }

        function updateProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            const progressContainer = document.getElementById('progressContainer');
            progressBar.style.width = percent + '%';
            progressContainer.style.display = 'block';
        }

        async function testBackend() {
            try {
                log('🔧 Testing backend API...', 'info');
                const response = await fetch(`${API_BASE}/videos`);
                const data = await response.json();
                
                if (data.success) {
                    log(`✅ Backend API working! Found ${data.data.videos.length} videos`, 'success');
                } else {
                    throw new Error('API returned error');
                }
            } catch (error) {
                log(`❌ Backend test failed: ${error.message}`, 'error');
            }
        }

        async function testFrontend() {
            try {
                log('🎨 Testing frontend...', 'info');
                const response = await fetch('http://localhost:3000');
                
                if (response.ok) {
                    log('✅ Frontend is accessible!', 'success');
                } else {
                    throw new Error('Frontend not accessible');
                }
            } catch (error) {
                log(`❌ Frontend test failed: ${error.message}`, 'error');
            }
        }

        async function testUpload() {
            try {
                log('📤 Testing video upload...', 'info');
                
                if (!authToken) {
                    const response = await fetch(`${API_BASE}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: 'admin@example.com',
                            password: 'admin123'
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        authToken = data.data.token;
                        log('✅ Login successful', 'success');
                    } else {
                        throw new Error('Login failed');
                    }
                }

                // Create a simple test video
                const canvas = document.createElement('canvas');
                canvas.width = 320;
                canvas.height = 240;
                const ctx = canvas.getContext('2d');
                
                ctx.fillStyle = '#00ff00';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'white';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Test Video', canvas.width / 2, canvas.height / 2);
                
                const stream = canvas.captureStream(30);
                const mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
                const chunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    chunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    
                    const formData = new FormData();
                    formData.append('video', blob);
                    formData.append('title', 'Verification Test - ' + new Date().toLocaleTimeString());
                    formData.append('description', 'Testing complete functionality');
                    formData.append('category', 'other');

                    try {
                        updateProgress(20);
                        log('📤 Uploading video...', 'info');

                        const response = await fetch(`${API_BASE}/videos/upload`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${authToken}` },
                            body: formData
                        });

                        if (response.ok) {
                            const result = await response.json();
                            log(`✅ Upload successful! ID: ${result.data.video._id}`, 'success');
                            updateProgress(40);
                            log('⏳ Processing started...', 'info');
                        } else {
                            throw new Error('Upload failed');
                        }
                    } catch (error) {
                        log(`❌ Upload error: ${error.message}`, 'error');
                    }
                };
                
                mediaRecorder.start();
                setTimeout(() => mediaRecorder.stop(), 1000);
                
            } catch (error) {
                log(`❌ Upload test failed: ${error.message}`, 'error');
            }
        }

        function testProgress() {
            log('📊 Testing progress tracking...', 'info');
            
            // Simulate progress updates
            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                updateProgress(progress);
                log(`📊 Progress: ${progress}%`, 'info');
                
                if (progress >= 100) {
                    clearInterval(interval);
                    log('✅ Progress test completed!', 'success');
                }
            }, 200);
        }

        // Socket.IO connection
        socket.on('connect', () => {
            log('🔌 Connected to Socket.IO server', 'success');
        });

        socket.on('videoProcessingProgress', (data) => {
            updateProgress(data.progress);
            log(`📊 Real-time progress: ${data.progress.toFixed(1)}% - ${data.message}`, 'info');
            
            if (data.progress >= 100) {
                log('✅ Video processing completed!', 'success');
            }
        });

        // Initialize
        log('🚀 Final Verification Test Loaded', 'success');
        log('📋 Ready to test all components', 'info');
    </script>
</body>
</html>
