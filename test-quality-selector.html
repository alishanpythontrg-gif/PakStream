<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PakStream - Quality Selector Test</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #e94560;
        }

        .instructions {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .instructions h2 {
            color: #e94560;
            margin-bottom: 10px;
        }

        .instructions ol {
            margin-left: 20px;
        }

        .instructions li {
            margin: 5px 0;
        }

        .video-section {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        #videoPlayer {
            width: 100%;
            max-width: 800px;
            display: block;
            margin: 0 auto 20px;
            border-radius: 10px;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }

        button, select, input {
            padding: 10px 20px;
            background: #e94560;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background: #d13550;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        select, input {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px;
        }

        .info-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .info-section h3 {
            color: #e94560;
            margin-bottom: 10px;
        }

        .quality-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .quality-badge {
            background: rgba(233, 69, 96, 0.3);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            border: 2px solid #e94560;
        }

        .quality-badge.active {
            background: #e94560;
            font-weight: bold;
        }

        .status {
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            font-weight: bold;
        }

        .status.success {
            background: rgba(0, 255, 0, 0.2);
            border: 2px solid #00ff00;
        }

        .status.error {
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid #ff0000;
        }

        .status.info {
            background: rgba(0, 150, 255, 0.2);
            border: 2px solid #0096ff;
        }

        pre {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            margin-top: 10px;
        }

        .test-result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid;
        }

        .test-result.pass {
            background: rgba(0, 255, 0, 0.1);
            border-color: #00ff00;
        }

        .test-result.fail {
            background: rgba(255, 0, 0, 0.1);
            border-color: #ff0000;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé¨ PakStream Quality Selector Test</h1>

        <div class="instructions">
            <h2>üìù Test Instructions</h2>
            <ol>
                <li>Enter a video ID from your PakStream database (or use the test button to fetch latest)</li>
                <li>Click "Load Video" to initialize the player</li>
                <li>Check if multiple quality options appear (360p, 720p, 1080p, etc.)</li>
                <li>Try switching between different qualities</li>
                <li>Monitor the logs below for detailed information</li>
            </ol>
        </div>

        <div class="video-section">
            <div class="controls">
                <input type="text" id="videoIdInput" placeholder="Enter Video ID" style="flex: 1; max-width: 400px;">
                <button onclick="fetchLatestVideo()">üîç Fetch Latest Video</button>
                <button onclick="loadVideo()" id="loadBtn">‚ñ∂Ô∏è Load Video</button>
                <button onclick="testMasterPlaylist()" id="testBtn">üß™ Test Master Playlist</button>
            </div>

            <video id="videoPlayer" controls></video>

            <div class="info-section" id="videoInfo" style="display: none;">
                <h3>üìπ Video Information</h3>
                <div id="videoDetails"></div>
            </div>

            <div class="info-section" id="qualityInfo" style="display: none;">
                <h3>üéöÔ∏è Available Qualities</h3>
                <div id="qualityDetails"></div>
                <div class="quality-list" id="qualityList"></div>
            </div>

            <div class="info-section">
                <h3>üìä HLS.js Levels Debug</h3>
                <pre id="hlsDebug">Waiting for video to load...</pre>
            </div>

            <div class="info-section">
                <h3>üìù Console Logs</h3>
                <pre id="consoleLogs">Initializing test...</pre>
            </div>

            <div id="testResults"></div>
        </div>
    </div>

    <script>
        let hls = null;
        let currentVideoId = null;
        let logs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push(`[${timestamp}] ${message}`);
            const consoleEl = document.getElementById('consoleLogs');
            consoleEl.textContent = logs.slice(-20).join('\n');
            console.log(message);
        }

        async function fetchLatestVideo() {
            try {
                log('Fetching latest video from API...');
                const response = await fetch('http://localhost:5000/api/videos?limit=1&status=ready');
                const data = await response.json();
                
                if (data.success && data.data.videos.length > 0) {
                    const video = data.data.videos[0];
                    currentVideoId = video._id;
                    document.getElementById('videoIdInput').value = currentVideoId;
                    log(`‚úÖ Found video: ${video.title} (ID: ${currentVideoId})`);
                    displayVideoInfo(video);
                    return currentVideoId;
                } else {
                    log('‚ùå No ready videos found', 'error');
                    alert('No ready videos found. Please upload and process a video first.');
                }
            } catch (error) {
                log(`‚ùå Error fetching video: ${error.message}`, 'error');
                alert('Error connecting to backend. Make sure the server is running on http://localhost:5000');
            }
        }

        function displayVideoInfo(video) {
            const infoEl = document.getElementById('videoInfo');
            const detailsEl = document.getElementById('videoDetails');
            
            infoEl.style.display = 'block';
            detailsEl.innerHTML = `
                <p><strong>Title:</strong> ${video.title}</p>
                <p><strong>Duration:</strong> ${Math.floor(video.duration / 60)}:${String(Math.floor(video.duration % 60)).padStart(2, '0')}</p>
                <p><strong>Resolution:</strong> ${video.resolution}</p>
                <p><strong>Status:</strong> ${video.status}</p>
                <p><strong>Variants:</strong> ${video.processedFiles?.hls?.variants?.length || 0}</p>
            `;
        }

        async function testMasterPlaylist() {
            const videoId = document.getElementById('videoIdInput').value || currentVideoId;
            if (!videoId) {
                alert('Please enter a video ID first');
                return;
            }

            try {
                log('üß™ Testing master playlist format...');
                const masterUrl = `http://localhost:5000/uploads/videos/processed/${videoId}/hls/${videoId}_master.m3u8`;
                
                const response = await fetch(masterUrl);
                const playlistText = await response.text();
                
                log('üìÑ Master Playlist Content:');
                log(playlistText);
                
                // Test resolution format
                const resolutionLines = playlistText.match(/RESOLUTION=[^\s,]*/g) || [];
                const testResults = document.getElementById('testResults');
                
                let allPassed = true;
                let resultsHTML = '<div class="test-result';
                
                resolutionLines.forEach(line => {
                    const resolution = line.split('=')[1];
                    const isCorrectFormat = /^\d+x\d+$/.test(resolution);
                    
                    if (isCorrectFormat) {
                        log(`‚úÖ ${line} - CORRECT FORMAT`);
                    } else {
                        log(`‚ùå ${line} - WRONG FORMAT (should be WIDTHxHEIGHT)`);
                        allPassed = false;
                    }
                });
                
                resultsHTML += allPassed ? ' pass">' : ' fail">';
                resultsHTML += `<h3>${allPassed ? '‚úÖ TEST PASSED' : '‚ùå TEST FAILED'}</h3>`;
                resultsHTML += `<p>${resolutionLines.length} quality variants found</p>`;
                resultsHTML += `<p>Resolution format: ${allPassed ? 'Correct (WIDTHxHEIGHT)' : 'Incorrect (contains "p" suffix)'}</p>`;
                
                if (!allPassed) {
                    resultsHTML += '<p><strong>Action Required:</strong> Re-process this video to get the correct format</p>';
                }
                
                resultsHTML += '</div>';
                testResults.innerHTML = resultsHTML;
                
            } catch (error) {
                log(`‚ùå Error testing playlist: ${error.message}`, 'error');
            }
        }

        async function loadVideo() {
            const videoId = document.getElementById('videoIdInput').value || currentVideoId;
            if (!videoId) {
                alert('Please enter a video ID or fetch latest video');
                return;
            }

            currentVideoId = videoId;
            const videoElement = document.getElementById('videoPlayer');
            const masterUrl = `http://localhost:5000/uploads/videos/processed/${videoId}/hls/${videoId}_master.m3u8`;

            log(`Loading video from: ${masterUrl}`);

            if (Hls.isSupported()) {
                // Destroy existing instance
                if (hls) {
                    hls.destroy();
                }

                hls = new Hls({
                    debug: false,
                    enableWorker: true,
                    lowLatencyMode: true,
                });

                hls.loadSource(masterUrl);
                hls.attachMedia(videoElement);

                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    log('‚úÖ HLS Manifest Parsed Successfully');
                    log(`Found ${hls.levels.length} quality levels`);

                    // Display quality information
                    displayQualityInfo(hls.levels);

                    // Debug log all levels
                    const debugInfo = hls.levels.map((level, index) => {
                        return `Level ${index}: ${level.width}x${level.height} @ ${Math.round(level.bitrate / 1000)}kbps`;
                    }).join('\n');

                    document.getElementById('hlsDebug').textContent = 
                        `Total Levels: ${hls.levels.length}\n\n` + debugInfo;

                    videoElement.play().catch(e => log('Autoplay prevented: ' + e.message));
                });

                hls.on(Hls.Events.LEVEL_SWITCHED, function(event, data) {
                    const level = hls.levels[data.level];
                    log(`üîÑ Quality switched to: ${level.height}p (${level.width}x${level.height})`);
                    updateActiveQuality(level.height);
                });

                hls.on(Hls.Events.ERROR, function(event, data) {
                    if (data.fatal) {
                        log(`‚ùå Fatal error: ${data.type} - ${data.details}`, 'error');
                        
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                log('Trying to recover from network error...');
                                hls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                log('Trying to recover from media error...');
                                hls.recoverMediaError();
                                break;
                            default:
                                log('Cannot recover from error, destroying HLS instance');
                                hls.destroy();
                                break;
                        }
                    } else {
                        log(`‚ö†Ô∏è Non-fatal error: ${data.details}`, 'warning');
                    }
                });

            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                log('Using native HLS support (Safari)');
                videoElement.src = masterUrl;
                videoElement.addEventListener('loadedmetadata', function() {
                    log('‚úÖ Video metadata loaded (native HLS)');
                    videoElement.play().catch(e => log('Autoplay prevented: ' + e.message));
                });
            } else {
                log('‚ùå HLS is not supported in this browser', 'error');
                alert('HLS is not supported in this browser. Please use a modern browser.');
            }
        }

        function displayQualityInfo(levels) {
            const qualityInfo = document.getElementById('qualityInfo');
            const qualityDetails = document.getElementById('qualityDetails');
            const qualityList = document.getElementById('qualityList');

            qualityInfo.style.display = 'block';

            if (levels.length === 0) {
                qualityDetails.innerHTML = '<p class="status error">‚ùå No quality levels detected! Check the master playlist format.</p>';
                return;
            }

            const validLevels = levels.filter(l => l.height && l.height > 0);
            
            if (validLevels.length === 0) {
                qualityDetails.innerHTML = '<p class="status error">‚ùå All quality levels have invalid dimensions (height=0)</p>';
                qualityDetails.innerHTML += '<p>This indicates the master playlist has incorrect RESOLUTION format.</p>';
                qualityDetails.innerHTML += '<p><strong>Expected:</strong> RESOLUTION=1280x720</p>';
                qualityDetails.innerHTML += '<p><strong>Got:</strong> RESOLUTION=720p</p>';
                return;
            }

            qualityDetails.innerHTML = `<p class="status success">‚úÖ ${validLevels.length} valid quality levels detected</p>`;

            qualityList.innerHTML = '<span class="quality-badge active">Auto</span>';
            validLevels.forEach((level, index) => {
                qualityList.innerHTML += `<span class="quality-badge" data-height="${level.height}">${level.height}p</span>`;
            });

            // Add click handlers for quality badges
            document.querySelectorAll('.quality-badge').forEach(badge => {
                badge.addEventListener('click', function() {
                    const height = this.getAttribute('data-height');
                    if (!height) {
                        // Auto mode
                        hls.currentLevel = -1;
                        log('Switched to Auto quality');
                    } else {
                        const levelIndex = hls.levels.findIndex(l => l.height === parseInt(height));
                        if (levelIndex >= 0) {
                            hls.currentLevel = levelIndex;
                            log(`Switched to ${height}p quality`);
                        }
                    }
                });
            });
        }

        function updateActiveQuality(height) {
            document.querySelectorAll('.quality-badge').forEach(badge => {
                badge.classList.remove('active');
                if (badge.getAttribute('data-height') === String(height)) {
                    badge.classList.add('active');
                }
            });
        }

        // Initialize
        log('üöÄ Quality Selector Test initialized');
        log('Waiting for video ID...');
    </script>
</body>
</html>

